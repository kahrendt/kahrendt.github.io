<!doctype html>
<html>
  <head>
  <title>
    
      Standard Deviation Filter for ESPHome | Kevin Ahrendt
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <!-- Use Atom -->
  <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Kevin Ahrendt" />
  <!-- RSS-v2.0
  <link href="/rss-feed.xml" type="application/rss+xml" rel="alternate" title="Kevin Ahrendt | A personal website for 3D printing, mathematics, data science, and home automation."/>
  //-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Source+Code+Pro">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <!-- Google Analytics -->
  <!-- <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script>
 -->
  <!-- Use Jekyll SEO plugin -->
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Standard Deviation Filter for ESPHome | Kevin Ahrendt</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Standard Deviation Filter for ESPHome" />
<meta name="author" content="Kevin Ahrendt" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The standard deviation of a set of sensor readings measures the variation in the sensor’s observations. A standard deviation close to zero implies the sensor observations tend to be near the mean/average of all observations. In other words, the measurements are consistent and not dispersed. A standard deviation much larger than zero implies the opposite. In other words, the observations are dispersed and not consistent. If we compute the standard deviation from the set of measurements from a sensor, we can determine whether or not those observations are consistent." />
<meta property="og:description" content="The standard deviation of a set of sensor readings measures the variation in the sensor’s observations. A standard deviation close to zero implies the sensor observations tend to be near the mean/average of all observations. In other words, the measurements are consistent and not dispersed. A standard deviation much larger than zero implies the opposite. In other words, the observations are dispersed and not consistent. If we compute the standard deviation from the set of measurements from a sensor, we can determine whether or not those observations are consistent." />
<meta property="og:site_name" content="Kevin Ahrendt" />
<meta property="og:image" content="/chart-bell-curve.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-03-24T00:00:00-04:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/chart-bell-curve.png" />
<meta property="twitter:title" content="Standard Deviation Filter for ESPHome" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kevin Ahrendt"},"dateModified":"2023-03-24T00:00:00-04:00","datePublished":"2023-03-24T00:00:00-04:00","description":"The standard deviation of a set of sensor readings measures the variation in the sensor’s observations. A standard deviation close to zero implies the sensor observations tend to be near the mean/average of all observations. In other words, the measurements are consistent and not dispersed. A standard deviation much larger than zero implies the opposite. In other words, the observations are dispersed and not consistent. If we compute the standard deviation from the set of measurements from a sensor, we can determine whether or not those observations are consistent.","headline":"Standard Deviation Filter for ESPHome","image":"/chart-bell-curve.png","mainEntityOfPage":{"@type":"WebPage","@id":"/standard-deviation-esphome"},"url":"/standard-deviation-esphome"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <div class="container">
      <header class="site-header">
  <h3 class="site-title">
    <a href="/">Kevin Ahrendt</a>
  </h3>
  <nav class="menu-list">
    
      <a href="/3d-printing" class="menu-link">3D Printing</a>
    
      <a href="/programming" class="menu-link">Programming</a>
    
      <a href="/smart-home" class="menu-link">Smart Home Data</a>
    
      <a href="/academics" class="menu-link">Academics</a>
    
      <a href="/about-me" class="menu-link">About Me</a>
    
      <a href="/contact" class="menu-link">Contact</a>
    
    
  </nav>
  <div class="dropdown">
    <button class="dropbtn"><i class="fa fa-bars" aria-hidden="true"></i></button>
    <div class="dropdown-content">
      
        <a href="/3d-printing" class="menu-link">3D Printing</a>
      
        <a href="/programming" class="menu-link">Programming</a>
      
        <a href="/smart-home" class="menu-link">Smart Home Data</a>
      
        <a href="/academics" class="menu-link">Academics</a>
      
        <a href="/about-me" class="menu-link">About Me</a>
      
        <a href="/contact" class="menu-link">Contact</a>
      
      
    </div>
  </div>
</header>

      <div class="content-wrapper">
        <div class="post-content">
  <h1>
    Standard Deviation Filter for ESPHome
  </h1>
  
    <span class="post-date">
  Written on
  
  March
  24th,
  2023
  by
  
    Kevin Ahrendt
  
</span>

  
  
    <div class="featured-image">
      <img src="/assets/img/chart-bell-curve.png">
    </div>
  
  <article>
    <p>The <a href="https://en.wikipedia.org/wiki/Standard_deviation">standard deviation</a> of a set of sensor readings measures the variation in the sensor’s observations. A standard deviation close to zero implies the sensor observations tend to be near the mean/average of all observations. In other words, the measurements are consistent and not dispersed. A standard deviation much larger than zero implies the opposite. In other words, the observations are dispersed and not consistent. If we compute the standard deviation from the set of measurements from a sensor, we can determine whether or not those observations are consistent.</p>

<p>The following code for ESPHome uses a <a href="https://esphome.io/components/sensor/index.html#lambda">custom lambda filter</a> to compute the standard deviation of measurements from a sensor. It applies the filter to a <a href="https://esphome.io/components/copy.html">copy integration</a> sensor, which requires another defined sensor with a designated id. We could apply the lambda filter directly to a sensor itself, but then ESPHome would send only the standard deviation of the measurements to Home Assistant and not the actual measurement value. The parameters <code class="language-plaintext highlighter-rouge">window_size_</code> and <code class="language-plaintext highlighter-rouge">send_every_</code> correspond to the configuration values <code class="language-plaintext highlighter-rouge">window_size</code> and <code class="language-plaintext highlighter-rouge">send_every</code> for any of the built-in ESPHome sensor filters.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sensor:
  - platform: copy
    name: "Standard Deviation of measurements"
    source_id: another_sensor_id
    filters:
      - lambda: |-
          // max measurements to store for computing standard deviation
          const uint8_t window_size_ = 60;
          // compute and send the standard deviation after this many measurements
          const uint8_t send_every_ = 15; 

          static std::deque&lt;float&gt; queue_;
          static uint8_t send_at_ = 0;
          
          // If we have more entries in queue_ than the window_size_, 
          // then pop them off
          while (queue_.size() &gt;= window_size_) {
            queue_.pop_front();
          }

          // add the newest reading to queue_
          queue_.push_back(x);

          if (++send_at_ &gt;= send_every_) {
            send_at_ = 0;

            float Ex = 0.0;
            float Ex2 = 0.0;
            size_t count = 0;

            float K = queue_.front();
            
            for (auto v: queue_) {
              if (!std::isnan(v)) {
                // Welford's algorithm to avoid catastrophic cancellation
                //  - This is achieved by subtracting the oldest reading from 
                //    each measurement. If not done, then the sum of the 
                //    measurements squared and the square of the measurements 
                //    summed may be quite large, and their difference can be 
                //    problematic resulting in catastrophic cancellation

                // counts valid measurements
                count += 1;
                // sums the measurement minus the oldest reading
                Ex += v - K;
                 // sums the measurement minus the oldest reading squared
                Ex2 += pow(v-K,2);
              }
            }

            float standard_deviation = NAN;
            // If we have at least one valid reading, then compute the 
            // variance and standard deviation, otherwise it will remain NAN
            if (count) {
              float variance = (Ex2 - pow(Ex, 2)/count) / (count-1);
              // standard deviation is the square root of the variance
              standard_deviation = sqrt(variance); 
            }

            return standard_deviation;
          }
          return {};
</code></pre></div></div>

<p>We compute the standard deviation by taking the square root of the variance. If we naïvely compute the variance, then we may encounter <a href="https://en.wikipedia.org/wiki/Catastrophic_cancellation">catastrophic cancellation</a>. Using the naïve approach, we would compute the sum of the measurements and the sum of the squared measurements. Computing the variance involves taking the difference between the sum of the squared measurements and the sum of the measurements that are then squared and divided by the number of measurements. If the measurements are large values to start, and if there are a large number of measurements, then these two numbers can be very similar, which can cause cancellation to a degree where the floating-point arithmetic cannot be precise enough. We can avoid this by using <a href="https://en.wikipedia.org/wiki/Algorithms_for_calculating_variance">Welford’s algorithm</a> to compute the variance in a single pass.</p>

  </article>
  
  
  
</div>

      </div>
      <footer class="footer">
  
  <div class="footer-description"><a href="/">Kevin Ahrendt | A personal website for 3D printing, mathematics, data science, and home automation.</a></div>
</footer>

    </div>
  </body>
</html>
